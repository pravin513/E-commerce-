<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout - DK Mega Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 20px; margin-top: 20px; border-radius: 8px; }
    h2 { text-align: center; }
    label { display: block; margin-top: 15px; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px;
    }
    button { background: #28a745; color: white; border: none; cursor: pointer; margin-top: 20px; }
    button:hover { background: #218838; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Checkout</h2>
    <form id="checkoutForm">
      <label>Full Name</label>
      <input type="text" id="name" required>
      
      <label>Email</label>
      <input type="email" id="email" required>

      <label>Delivery Address</label>
      <textarea id="address" rows="3" required></textarea>

      <label>Payment Method</label>
      <select id="paymentMethod" required>
        <option value="">Select</option>
        <option value="COD">Cash on Delivery</option>
        <option value="UPI">UPI</option>
        <option value="Card">Credit/Debit Card</option>
      </select>

      <button type="submit">Place Order</button>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB4Ga1n1tNDY4vtBiozqYo2_IraAGSFdE8",
      authDomain: "dk-mega-store.firebaseapp.com",
      projectId: "dk-mega-store",
      storageBucket: "dk-mega-store.firebasestorage.app",
      messagingSenderId: "309244990744",
      appId: "1:309244990744:web:f4c9dbd446319aa1d83a6d",
      databaseURL: "https://dk-mega-store-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('email').value = user.email;
        db.ref('users/' + user.uid).once('value').then(snapshot => {
          const data = snapshot.val();
          if (data && data.name) document.getElementById('name').value = data.name;
        });
      } else {
        window.location.href = "login.html";
      }
    });

    document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const address = document.getElementById('address').value;
      const paymentMethod = document.getElementById('paymentMethod').value;

      // Fetch cart
      const cartSnap = await db.ref('carts/' + user.uid).once('value');
      const cartData = cartSnap.val() || {};

      if (Object.keys(cartData).length === 0) {
        alert("Cart is empty!");
        return;
      }

      const orderId = Date.now();

      // Save order
      await db.ref('orders/' + user.uid + '/' + orderId).set({
        name, email, address, paymentMethod,
        items: cartData,
        date: new Date().toLocaleString(),
        status: "Pending"
      });

      // Clear cart
      await db.ref('carts/' + user.uid).remove();

      window.location.href = "thankyou.html";
    });
  </script>
</body>
</html>
